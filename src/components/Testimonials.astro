---
import { ChevronLeft, ChevronRight } from "lucide-astro";
---

<section id="Testimonials" class="section-padding section-reveal">
  <div class="p-4 md:p-8">
    <div class="header-container flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
      <div class="flex-1">
        <h1 class="title-reveal">Histórias Que Inspiram: Nossos Clientes Falam.</h1>
      </div>
      
      <div class="carousel-controls flex gap-2 self-end md:self-auto flex-shrink-0"> 
        <button class="carousel-btn carousel-btn-prev bg-gray-200 hover:bg-gray-300 rounded-full p-3 transition-all duration-200" id="prevBtnTestimonials" aria-label="Previous slide">
          <ChevronLeft size={20} class="text-gray-700" />
        </button>
        <button class="carousel-btn carousel-btn-next bg-gray-200 hover:bg-gray-300 rounded-full p-3 transition-all duration-200" id="nextBtnTestimonials" aria-label="Next slide">
          <ChevronRight size={20} class="text-gray-700" />
        </button>
      </div>
    </div>
    
    <div class="carousel-wrapper-outer relative">
      <div class="carousel-container overflow-hidden relative z-10">
        <div class="carousel-track flex transition-transform duration-500 ease-in-out gap-6 pb-4">
          <div class="testimonial-reveal flex-none w-full md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)] xl:w-[calc(25%-18px)] p-4 bg-white rounded-lg shadow-md flex flex-col min-h-[280px]">
            <p class="text-gray-700 text-lg mb-4 flex-grow">"A BNI Tour superou todas as nossas expectativas! Cada detalhe da viagem foi planejado com maestria para a nossa família. Uma experiência incrível do início ao fim!"</p>
            <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
              <div class="flex-shrink-0">
                <p class="font-semibold text-gray-900">Ana Paula S.</p>
                <p class="text-sm text-gray-500">Cliente Satisfeita</p>
              </div>
              <a href='https://www.tripadvisor.com.br/Attraction_Review-g303444-d17724059-Reviews-Bni_Tour-Foz_do_Iguacu_State_of_Parana.html' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                <span class="button-content-initial-text">Ver no Tripadvisor</span>
                <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                </div>
            </a>
            </div>
          </div>

          <div class="testimonial-reveal flex-none w-full md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)] xl:w-[calc(25%-18px)] p-4 bg-white rounded-lg shadow-md flex flex-col min-h-[280px]">
            <p class="text-gray-700 text-lg mb-4 flex-grow">"Nunca imaginei que uma viagem pudesse ser tão tranquila e personalizada. Os roteiros da BNI Tour nos permitiram aproveitar cada momento sem preocupações. Altamente recomendado!"</p>
            <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
              <div class="flex-shrink-0">
                <p class="font-semibold text-gray-900">João M.</p>
                <p class="text-sm text-gray-500">Aventureiro de plantão</p>
              </div>
              <a href='https://www.google.com/travel' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                <span class="button-content-initial-text">Avaliar no Google</span>
                <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                </div>
            </a>
            </div>
          </div>

          <div class="testimonial-reveal flex-none w-full md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)] xl:w-[calc(25%-18px)] p-4 bg-white rounded-lg shadow-md flex flex-col min-h-[280px]">
            <p class="text-gray-700 text-lg mb-4 flex-grow">"Simplesmente perfeito! Desde o atendimento inicial até o retorno, a equipe da BNI Tour foi impecável. Minha família e eu tivemos uma experiência inesquecível em Foz do Iguaçu."</p>
            <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
              <div class="flex-shrink-0">
                <p class="font-semibold text-gray-900">Mariana P.</p>
                <p class="text-sm text-gray-500">Amante de viagens</p>
              </div>
              <a href='https://www.tripadvisor.com.br/Attraction_Review-g303444-d17724059-Reviews-Bni_Tour-Foz_do_Iguacu_State_of_Parana.html' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                <span class="button-content-initial-text">Ver no Tripadvisor</span>
                <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                </div>
            </a>
            </div>
          </div>

          <div class="testimonial-reveal flex-none w-full md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)] xl:w-[calc(25%-18px)] p-4 bg-white rounded-lg shadow-md flex flex-col min-h-[280px]">
            <p class="text-gray-700 text-lg mb-4 flex-grow">"Viajar com a BNI Tour é garantia de tranquilidade. Roteiros excelentes e motoristas muito atenciosos. Recomendo para quem busca uma viagem sem preocupações!"</p>
            <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
              <div class="flex-shrink-0">
                <p class="font-semibold text-gray-900">Carlos R.</p>
                <p class="text-sm text-gray-500">Viajante frequente</p>
              </div>
              <a href='https://www.google.com/travel' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                <span class="button-content-initial-text">Avaliar no Google</span>
                <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                </div>
            </a>
            </div>
          </div>

          <div class="testimonial-reveal flex-none w-full md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)] xl:w-[calc(25%-18px)] p-4 bg-white rounded-lg shadow-md flex flex-col min-h-[280px]">
            <p class="text-gray-700 text-lg mb-4 flex-grow">"Experiência incrível na tríplice fronteira! A BNI Tour nos proporcionou momentos inesquecíveis, com todo o conforto e segurança. Mal podemos esperar para a próxima!"</p>
            <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
              <div class="flex-shrink-0">
                <p class="font-semibold text-gray-900">Fernanda L.</p>
                <p class="text-sm text-gray-500">Exploradora</p>
              </div>
             <a href='https://www.tripadvisor.com.br/Attraction_Review-g303444-d17724059-Reviews-Bni_Tour-Foz_do_Iguacu_State_of_Parana.html' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                <span class="button-content-initial-text">Ver no Tripadvisor</span>
                <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                </div>
            </a>
            </div>
          </div>

          <div class="testimonial-reveal flex-none w-full md:w-[calc(50%-12px)] lg:w-[calc(33.333%-16px)] xl:w-[calc(25%-18px)] p-4 bg-white rounded-lg shadow-md flex flex-col min-h-[280px]">
            <p class="text-gray-700 text-lg mb-4 flex-grow">"Atendimento personalizado e guias muito bem informados. Minha viagem para as Cataratas foi perfeita, graças ao planejamento cuidadoso da BNI Tour."</p>
            <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
              <div class="flex-shrink-0">
                <p class="font-semibold text-gray-900">Pedro H.</p>
                <p class="text-sm text-gray-500">Amante da natureza</p>
              </div>
              <a href='https://www.google.com/travel' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                <span class="button-content-initial-text">Avaliar no Google</span>
                <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                </div>
            </a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const testimonialSection = document.getElementById('Testimonials');
    if (!testimonialSection) return;

    const carouselTrack = testimonialSection.querySelector('.carousel-track') as HTMLElement;
    const prevBtn = testimonialSection.querySelector('#prevBtnTestimonials') as HTMLButtonElement;
    const nextBtn = testimonialSection.querySelector('#nextBtnTestimonials') as HTMLButtonElement;
    const cards = Array.from(carouselTrack.children) as HTMLElement[];

    if (!carouselTrack || !prevBtn || !nextBtn || cards.length === 0) {
      console.warn("Carrossel de depoimentos não inicializado: Elementos essenciais não encontrados ou cards vazios.");
      return;
    }
    
    let currentSlide = 0;
    let cardsPerPage = 1;
    let cardWidth = 0;
    const carouselGap = 24; 

    function updateCardsPerPage() {
      if (window.innerWidth >= 1280) { 
        cardsPerPage = 4;
      } else if (window.innerWidth >= 1024) { 
        cardsPerPage = 3;
      } else if (window.innerWidth >= 768) { 
        cardsPerPage = 2;
      } else { 
        cardsPerPage = 1;
      }
    }

    function calculateCardWidth() {
      if (cards.length > 0) {
        cardWidth = cards[0].offsetWidth;
      } else {
        cardWidth = 0;
      }
    }
    
    function updateCarouselPosition() {
      const offset = (cardWidth + carouselGap) * currentSlide;
      carouselTrack.style.transform = `translateX(-${offset}px)`;
      updateButtonStates();
    }

    function updateButtonStates() {
      if (currentSlide === 0) {
        prevBtn.style.display = 'none'; 
      } else {
        prevBtn.style.display = 'flex'; 
      }

      const maxIndex = Math.max(0, cards.length - cardsPerPage);
      if (currentSlide >= maxIndex) {
        nextBtn.style.display = 'none'; 
      } else {
        nextBtn.style.display = 'flex'; 
      }
    }

    function showNextSlide() {
      const maxIndex = Math.max(0, cards.length - cardsPerPage);
      if (currentSlide < maxIndex) {
        currentSlide++;
      } else {
        currentSlide = 0; 
      }
      updateCarouselPosition();
    }

    function showPrevSlide() {
      if (currentSlide > 0) {
        currentSlide--;
      } else {
        currentSlide = Math.max(0, cards.length - cardsPerPage); 
      }
      updateCarouselPosition();
    }

    function initializeCarousel() {
      updateCardsPerPage();
      calculateCardWidth();
      updateCarouselPosition();
    }

    let resizeTimeout: number | null = null; 
    window.addEventListener('resize', () => {
      if (resizeTimeout) {
        clearTimeout(resizeTimeout);
      }
      resizeTimeout = setTimeout(() => {
        initializeCarousel();
        const maxSlide = Math.max(0, cards.length - cardsPerPage);
        if (currentSlide > maxSlide) {
          currentSlide = maxSlide;
        }
        updateCarouselPosition();
      }, 250) as unknown as number; 
    });

    prevBtn.addEventListener('click', showPrevSlide);
    nextBtn.addEventListener('click', showNextSlide);

    initializeCarousel();

    const observerOptions = {
        root: null,
        rootMargin: '0px',
        threshold: 0.1
    };

    const sectionObserverCallback = (entries: IntersectionObserverEntry[], observer: IntersectionObserver) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const section = entry.target as HTMLElement;
                section.classList.add('section-reveal-active');

                if (section.id === 'Testimonials') {
                    // Animar título
                    const testimonialTitle = section.querySelector('.title-reveal') as HTMLElement;
                    if (testimonialTitle) {
                        setTimeout(() => { 
                            testimonialTitle.classList.add('is-visible'); 
                        }, 300); 
                    }

                    const testimonialCards = section.querySelectorAll('.testimonial-reveal') as NodeListOf<HTMLElement>;
                    testimonialCards.forEach((card: HTMLElement, index: number) => {
                        setTimeout(() => { 
                            card.classList.add('is-visible'); 
                        }, 600 + (index * 150)); 
                    });
                }
                observer.unobserve(section);
            }
        });
    };

    const sectionObserver = new IntersectionObserver(sectionObserverCallback, observerOptions);
    const revealSections = document.querySelectorAll('.section-reveal');
    revealSections.forEach(section => {
        sectionObserver.observe(section);
    });
});
</script>