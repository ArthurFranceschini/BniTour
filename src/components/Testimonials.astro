---
import { ChevronLeft, ChevronRight } from "lucide-astro";
---

<section id="Testimonials" class="section-padding section-reveal">
  <div class="p-4 md:p-8">
    <div class="header-container flex justify-between items-center mb-4">
      <h1 class="title-reveal w-full" data-translate="testimonials.title">Histórias Que Inspiram: Nossos Clientes Falam.</h1>
      
      <div class="carousel-controls flex-shrink-0"> 
        <button class="carousel-btn carousel-btn-prev" id="prevBtnTestimonials" style="display: none;">
          <ChevronLeft size={20} />
        </button>
        <button class="carousel-btn carousel-btn-next" id="nextBtnTestimonials">
          <ChevronRight size={20} />
        </button>
      </div>
    </div>
    
    <div class="carousel-wrapper-outer relative">
      <div class="carousel-container overflow-hidden relative z-10 pb-8">
        <div class="carousel-track flex transition-transform duration-500 ease-in-out pb-4 items-stretch" id="testimonials-track">
          
          <div class="testimonial-card testimonial-reveal flex-none">
            <div class="testimonial-content p-4 bg-white rounded-lg shadow-md hover:shadow-lg flex flex-col">
              <p class="text-gray-700 text-lg mb-4 flex-grow" data-translate="testimonials.ana.quote">"A BNI Tour superou todas as nossas expectativas! Cada detalhe da viagem foi planejado com maestria para a nossa família. Uma experiência incrível do início ao fim!"</p>
              <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
                <div class="flex-shrink-0">
                  <p class="font-semibold text-gray-900" data-translate="testimonials.ana.name">Ana Paula S.</p>
                  <p class="text-sm text-gray-500" data-translate="testimonials.ana.role">Cliente Satisfeita</p>
                </div>
                <a href='https://www.tripadvisor.com.br/Attraction_Review-g303444-d17724059-Reviews-Bni_Tour-Foz_do_Iguacu_State_of_Parana.html' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                  <span class="button-content-initial-text" data-translate="testimonials.btn.tripadvisor">Ver no Tripadvisor</span>
                  <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                  </div>
                </a>
              </div>
            </div>
          </div>

          <div class="testimonial-card testimonial-reveal flex-none">
            <div class="testimonial-content p-4 bg-white rounded-lg shadow-md hover:shadow-lg flex flex-col">
              <p class="text-gray-700 text-lg mb-4 flex-grow" data-translate="testimonials.joao.quote">"Nunca imaginei que uma viagem pudesse ser tão tranquila e personalizada. Os roteiros da BNI Tour nos permitiram aproveitar cada momento sem preocupações. Altamente recomendado!"</p>
              <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
                <div class="flex-shrink-0">
                  <p class="font-semibold text-gray-900" data-translate="testimonials.joao.name">João M.</p>
                  <p class="text-sm text-gray-500" data-translate="testimonials.joao.role">Aventureiro de plantão</p>
                </div>
                <a href='https://www.google.com/travel' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                  <span class="button-content-initial-text" data-translate="testimonials.btn.google">Avaliar no Google</span>
                  <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                  </div>
                </a>
              </div>
            </div>
          </div>

          <div class="testimonial-card testimonial-reveal flex-none">
            <div class="testimonial-content p-4 bg-white rounded-lg shadow-md hover:shadow-lg flex flex-col">
              <p class="text-gray-700 text-lg mb-4 flex-grow" data-translate="testimonials.mariana.quote">"Simplesmente perfeito! Desde o atendimento inicial até o retorno, a equipe da BNI Tour foi impecável. Minha família e eu tivemos uma experiência inesquecível em Foz do Iguaçu."</p>
              <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
                <div class="flex-shrink-0">
                  <p class="font-semibold text-gray-900" data-translate="testimonials.mariana.name">Mariana P.</p>
                  <p class="text-sm text-gray-500" data-translate="testimonials.mariana.role">Amante de viagens</p>
                </div>
                <a href='https://www.tripadvisor.com.br/Attraction_Review-g303444-d17724059-Reviews-Bni_Tour-Foz_do_Iguacu_State_of_Parana.html' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                  <span class="button-content-initial-text" data-translate="testimonials.btn.tripadvisor">Ver no Tripadvisor</span>
                  <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                  </div>
                </a>
              </div>
            </div>
          </div>

          <div class="testimonial-card testimonial-reveal flex-none">
            <div class="testimonial-content p-4 bg-white rounded-lg shadow-md hover:shadow-lg flex flex-col">
              <p class="text-gray-700 text-lg mb-4 flex-grow" data-translate="testimonials.carlos.quote">"Viajar com a BNI Tour é garantia de tranquilidade. Roteiros excelentes e motoristas muito atenciosos. Recomendo para quem busca uma viagem sem preocupações!"</p>
              <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
                <div class="flex-shrink-0">
                  <p class="font-semibold text-gray-900" data-translate="testimonials.carlos.name">Carlos R.</p>
                  <p class="text-sm text-gray-500" data-translate="testimonials.carlos.role">Viajante frequente</p>
                </div>
                <a href='https://www.google.com/travel' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                  <span class="button-content-initial-text" data-translate="testimonials.btn.google">Avaliar no Google</span>
                  <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                  </div>
                </a>
              </div>
            </div>
          </div>

          <div class="testimonial-card testimonial-reveal flex-none">
            <div class="testimonial-content p-4 bg-white rounded-lg shadow-md hover:shadow-lg flex flex-col">
              <p class="text-gray-700 text-lg mb-4 flex-grow" data-translate="testimonials.fernanda.quote">"Experiência incrível na tríplice fronteira! A BNI Tour nos proporcionou momentos inesquecíveis, com todo o conforto e segurança. Mal podemos esperar para a próxima!"</p>
              <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
                <div class="flex-shrink-0">
                  <p class="font-semibold text-gray-900" data-translate="testimonials.fernanda.name">Fernanda L.</p>
                  <p class="text-sm text-gray-500" data-translate="testimonials.fernanda.role">Exploradora</p>
                </div>
                <a href='https://www.tripadvisor.com.br/Attraction_Review-g303444-d17724059-Reviews-Bni_Tour-Foz_do_Iguacu_State_of_Parana.html' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                  <span class="button-content-initial-text" data-translate="testimonials.btn.tripadvisor">Ver no Tripadvisor</span>
                  <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                  </div>
                </a>
              </div>
            </div>
          </div>

          <div class="testimonial-card testimonial-reveal flex-none">
            <div class="testimonial-content p-4 bg-white rounded-lg shadow-md hover:shadow-lg flex flex-col">
              <p class="text-gray-700 text-lg mb-4 flex-grow" data-translate="testimonials.pedro.quote">"Atendimento personalizado e guias muito bem informados. Minha viagem para as Cataratas foi perfeita, graças ao planejamento cuidadoso da BNI Tour."</p>
              <div class="flex flex-col 2xl:flex-row 2xl:items-center 2xl:justify-between gap-3 mt-auto">
                <div class="flex-shrink-0">
                  <p class="font-semibold text-gray-900" data-translate="testimonials.pedro.name">Pedro H.</p>
                  <p class="text-sm text-gray-500" data-translate="testimonials.pedro.role">Amante da natureza</p>
                </div>
                <a href='https://www.google.com/travel' class="btn-nav border-1 border-black text-black header-btn 2xl:self-auto self-start">
                  <span class="button-content-initial-text" data-translate="testimonials.btn.google">Avaliar no Google</span>
                  <div class="btn-cta-icon-wrapper button-content-initial-icon bg-black">
                    <ChevronRight size={20} class="text-white" />
                  </div>
                </a>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>
  </div>
</section>

<style>
html, body {
  overflow-x: hidden !important;
  max-width: 100vw !important;
}

@media (max-width: 768px) {
  .header-container {
    position: relative;
    margin-bottom: 120px;
    flex-direction: column;
    align-items: flex-start;
  }
  
  .header-container h1 {
    width: 100% !important;
  }
  
  .carousel-controls {
    position: absolute;
    top: 100%;
    left: 0;
    margin-top: 60px; 
  }
  
  .carousel-container {
    width: 100vw;
    margin-left: calc(-50vw + 50%);
    overflow: hidden !important;
  }
  
  .carousel-track {
    display: flex;
    transition: transform 0.3s ease;
    gap: 0;
  }
  
  .testimonial-card {
    flex: 0 0 100vw;
    width: 100vw;
    padding: 0 20px;
    box-sizing: border-box;
  }
  
  .testimonial-content {
    border-radius: 0 !important;
    min-height: 320px;
  }
}

@media (min-width: 769px) and (max-width: 1023px) {
  .header-container {
    flex-direction: row;
    margin-bottom: 2rem;
  }
  
  .carousel-track {
    gap: 1.5rem;
  }
  
  .testimonial-card {
    width: calc(50% - 0.75rem);
  }
}

/* Desktop Layout - 3+ cards */
@media (min-width: 1024px) {
  .header-container {
    flex-direction: row;
    margin-bottom: 2rem;
  }
  
  .carousel-track {
    gap: 1rem;
  }
  
  .testimonial-card {
    width: calc(33.333% - 0.667rem);
  }
}

@media (min-width: 1280px) {
  .testimonial-card {
    width: calc(25% - 0.75rem);
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const testimonialSection = document.getElementById('Testimonials');
  if (!testimonialSection) return;

  const sections = document.querySelectorAll('.section-reveal');
  
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('section-reveal-active');
        
        setTimeout(() => {
          const titles = entry.target.querySelectorAll('.title-reveal');
          titles.forEach((title, index) => {
            setTimeout(() => { 
              title.classList.add('is-visible');
            }, index * 200); 
          });
        }, 400);
        
        setTimeout(() => {
          const cards = entry.target.querySelectorAll('.testimonial-reveal');
          cards.forEach((card, index) => {
            setTimeout(() => {
              card.classList.add('is-visible');
            }, index * 200);
          });
        }, 800);
        
        setTimeout(() => {
          const ctaButtons = entry.target.querySelectorAll('.btn-nav');
          ctaButtons.forEach((button, index) => {
            setTimeout(() => {
              button.classList.add('is-revealed');
            }, index * 200);
          });
        }, 1200);
      }
    });
  });

  sections.forEach(section => observer.observe(section));

  const carouselTrack = testimonialSection.querySelector('.carousel-track') as HTMLElement;
  const prevBtn = testimonialSection.querySelector('#prevBtnTestimonials') as HTMLButtonElement;
  const nextBtn = testimonialSection.querySelector('#nextBtnTestimonials') as HTMLButtonElement;
  const cards = testimonialSection.querySelectorAll('.testimonial-card') as NodeListOf<HTMLElement>;
  const carouselContainer = testimonialSection.querySelector('.carousel-container') as HTMLElement;

  if (!carouselTrack || !prevBtn || !nextBtn || !carouselContainer || cards.length === 0) {
    return;
  }

  let currentIndex = 0;
  let autoPlayInterval: number | null = null;

  function getCardsToShow(): number {
    if (window.innerWidth <= 768) return 1;
    if (window.innerWidth <= 1023) return 2;
    if (window.innerWidth <= 1279) return 3;
    return 4;
  }

  function getMaxIndex(): number {
    return Math.max(0, cards.length - getCardsToShow());
  }

  function updateCarousel(): void {
    const cardsToShow = getCardsToShow();
    
    if (cardsToShow === 1) {
      carouselTrack.style.transform = `translateX(-${currentIndex * 100}vw)`;
    } else {
      const cardWidth = cards[0].offsetWidth;
      let gap: number;
      if (cardsToShow === 2) gap = 24;
      else if (cardsToShow === 3) gap = 16;
      else gap = 16;
      
      const translateX = -(currentIndex * (cardWidth + gap));
      carouselTrack.style.transform = `translateX(${translateX}px)`;
    }
    
    const maxIndex = getMaxIndex();
    
    prevBtn.style.display = currentIndex === 0 ? 'none' : 'flex';
    nextBtn.style.display = currentIndex >= maxIndex ? 'none' : 'flex';
  }

  function goToSlide(index: number): void {
    const maxIndex = getMaxIndex();
    currentIndex = Math.max(0, Math.min(index, maxIndex));
    updateCarousel();
  }

  function nextSlide(): void {
    const maxIndex = getMaxIndex();
    if (currentIndex < maxIndex) {
      goToSlide(currentIndex + 1);
    } else {
      goToSlide(0); 
    }
  }

  function prevSlide(): void {
    if (currentIndex > 0) {
      goToSlide(currentIndex - 1);
    } else {
      goToSlide(getMaxIndex()); 
    }
  }

  function startAutoPlay(): void {
    if (autoPlayInterval) {
      clearInterval(autoPlayInterval);
    }
    
    autoPlayInterval = window.setInterval(() => {
      nextSlide();
    }, 4000);
  }

  function stopAutoPlay(): void {
    if (autoPlayInterval) {
      clearInterval(autoPlayInterval);
      autoPlayInterval = null;
    }
  }

  function resetAutoPlay(): void {
    stopAutoPlay();
    startAutoPlay();
  }

  prevBtn.addEventListener('click', (e: Event) => {
    e.preventDefault();
    prevSlide();
    resetAutoPlay();
  });

  nextBtn.addEventListener('click', (e: Event) => {
    e.preventDefault();
    nextSlide();
    resetAutoPlay();
  });

  carouselContainer.addEventListener('mouseenter', stopAutoPlay);
  carouselContainer.addEventListener('mouseleave', startAutoPlay);

  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      stopAutoPlay();
    } else {
      startAutoPlay();
    }
  });

  window.addEventListener('resize', () => {
    const maxIndex = getMaxIndex();
    
    if (currentIndex > maxIndex) {
      currentIndex = maxIndex;
    }
    
    updateCarousel();
    resetAutoPlay();
  });

  let touchStartX = 0;
  let touchEndX = 0;

  carouselContainer.addEventListener('touchstart', (e: TouchEvent) => {
    touchStartX = e.changedTouches[0].screenX;
    stopAutoPlay();
  });

  carouselContainer.addEventListener('touchend', (e: TouchEvent) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
    startAutoPlay();
  });

  function handleSwipe(): void {
    const swipeThreshold = 50;
    const swipeDistance = touchStartX - touchEndX;
    
    if (Math.abs(swipeDistance) > swipeThreshold) {
      if (swipeDistance > 0) {
        nextSlide();
      } else {
        prevSlide();
      }
    }
  }

  function equalizeHeights(): void {
    const testimonialContents = document.querySelectorAll('#Testimonials .testimonial-content') as NodeListOf<HTMLElement>;
    
    let maxHeight = 0;

    testimonialContents.forEach(content => {
      content.style.height = 'auto'; 
      maxHeight = Math.max(maxHeight, content.offsetHeight); 
    });

    testimonialContents.forEach(content => {
      content.style.height = maxHeight + 'px';
    });
  }

  window.addEventListener('resize', () => {
    if (window.innerWidth <= 1366) {
      equalizeHeights();
    } else {
      const testimonialContents = document.querySelectorAll('#Testimonials .testimonial-content') as NodeListOf<HTMLElement>;
      testimonialContents.forEach(content => content.style.height = 'auto');
    }
  });

  updateCarousel();
  startAutoPlay();
  equalizeHeights();
});
</script>